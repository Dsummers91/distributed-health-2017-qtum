package main

import (
	"encoding/json"
	"fmt"
	"os/exec"
	"strings"
)

type Response struct {
	Version int `json:version"`
}

type Entity struct {
	datadir string
	rpcPort string
	address string
}

type CreateContractResponse struct {
	TransactionID string `json:"txid"`
	Sender        string `json:"sender"`
	Hash160       string `json:"hash160"`
	Address       string `json:"address"`
}

var mostRecentAddress string

var bin = "6060604052341561000f57600080fd5b4260058190555033600260006101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff160217905550610fba806100666000396000f3006060604052361561010f576000357c0100000000000000000000000000000000000000000000000000000000900463ffffffff1680621a2d42146101145780630b97bc861461017e57806311b5e6f0146101a757806320d9dae1146101d05780633e104a95146101fe5780634258cb9e14610253578063629e4ed01461027c57806366542aa7146102e657806366eae86e146103495780638ce900bd1461038b57806393066b4c146103f55780639ce110d7146104585780639f272ee2146104ad578063a996fa4a146104d6578063b116619d146104fb578063b2fa1c9e1461051e578063b60d42881461054b578063c24a0f8b1461056d578063cedece7414610596578063e89e4ed6146105bf575b600080fd5b341561011f57600080fd5b610127610625565b6040518080602001828103825283818151815260200191508051906020019060200280838360005b8381101561016a57808201518184015260208101905061014f565b505050509050019250505060405180910390f35b341561018957600080fd5b6101916106b9565b6040518082815260200191505060405180910390f35b34156101b257600080fd5b6101ba6106bf565b6040518082815260200191505060405180910390f35b34156101db57600080fd5b6101fc600480803515159060200190919080359060200190919050506106f3565b005b341561020957600080fd5b6102116107d7565b604051808273ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200191505060405180910390f35b341561025e57600080fd5b610266610801565b6040518082815260200191505060405180910390f35b341561028757600080fd5b61028f61080e565b6040518080602001828103825283818151815260200191508051906020019060200280838360005b838110156102d25780820151818401526020810190506102b7565b505050509050019250505060405180910390f35b34156102f157600080fd5b61030760048080359060200190919050506108b2565b604051808273ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200191505060405180910390f35b341561035457600080fd5b6103896004808035600019169060200190919080359060200190919080359060200190919080359060200190919050506108f1565b005b341561039657600080fd5b61039e6109b2565b6040518080602001828103825283818151815260200191508051906020019060200280838360005b838110156103e15780820151818401526020810190506103c6565b505050509050019250505060405180910390f35b341561040057600080fd5b6104166004808035906020019091905050610a46565b604051808273ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200191505060405180910390f35b341561046357600080fd5b61046b610a85565b604051808273ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200191505060405180910390f35b34156104b857600080fd5b6104c0610aab565b6040518082815260200191505060405180910390f35b34156104e157600080fd5b6104f960048080351515906020019091905050610b62565b005b341561050657600080fd5b61051c6004808035906020019091905050610c37565b005b341561052957600080fd5b610531610deb565b604051808215151515815260200191505060405180910390f35b610553610e1b565b604051808215151515815260200191505060405180910390f35b341561057857600080fd5b610580610e24565b6040518082815260200191505060405180910390f35b34156105a157600080fd5b6105a9610e2a565b6040518082815260200191505060405180910390f35b34156105ca57600080fd5b6105e06004808035906020019091905050610e30565b60405180876000191660001916815260200186815260200185815260200184815260200183815260200182151515158152602001965050505050505060405180910390f35b61062d610e88565b60018054806020026020016040519081016040528092919081815260200182805480156106af57602002820191906000526020600020905b8160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020019060010190808311610665575b5050505050905090565b60055481565b6000806018603c8060055442038115156106d557fe5b048115156106df57fe5b048115156106e957fe5b0490508091505090565b6201518081024201600681905550811561076f576000805480600101828161071b9190610e9c565b9160005260206000209001600033909190916101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff160217905550506107d3565b600180548060010182816107839190610e9c565b9160005260206000209001600033909190916101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff160217905550505b5050565b6000600260009054906101000a900473ffffffffffffffffffffffffffffffffffffffff16905090565b6000600380549050905090565b610816610ec8565b61081e610ec8565b60006003805490506040518059106108335750595b90808252806020026020018201604052509150600090505b6003805490508110156108aa5760038181548110151561086757fe5b906000526020600020906006020160000154828281518110151561088757fe5b90602001906020020190600019169081600019168152505080600101905061084b565b819250505090565b6001818154811015156108c157fe5b90600052602060002090016000915054906101000a900473ffffffffffffffffffffffffffffffffffffffff1681565b600380548060010182816109059190610edc565b9160005260206000209060060201600060c060405190810160405280886000191681526020016005548152602001878152602001868152602001858152602001600015158152509091909150600082015181600001906000191690556020820151816001015560408201518160020155606082015181600301556080820151816004015560a08201518160050160006101000a81548160ff02191690831515021790555050505050505050565b6109ba610e88565b6000805480602002602001604051908101604052809291908181526020018280548015610a3c57602002820191906000526020600020905b8160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190600101908083116109f2575b5050505050905090565b600081815481101515610a5557fe5b90600052602060002090016000915054906101000a900473ffffffffffffffffffffffffffffffffffffffff1681565b600260009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1681565b6000806000610ab86106bf565b9150600090505b600380549050811015610b5c5781600382815481101515610adc57fe5b906000526020600020906006020160020154118015610b2c575060001515600382815481101515610b0957fe5b906000526020600020906006020160050160009054906101000a900460ff161515145b15610b3957809250610b5d565b600160038054905003811415610b5157809250610b5d565b806001019050610abf565b5b505090565b8015610bd05760008054806001018281610b7c9190610e9c565b9160005260206000209001600033909190916101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff16021790555050610c34565b60018054806001018281610be49190610e9c565b9160005260206000209001600033909190916101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff160217905550505b50565b6000806000610c446106bf565b9250610c4e610aab565b9150600382815481101515610c5f57fe5b9060005260206000209060060201600401548410158015610ca25750600083600384815481101515610c8d57fe5b90600052602060002090600602016002015403115b8015610cdf575060001515600383815481101515610cbc57fe5b906000526020600020906006020160050160009054906101000a900460ff161515145b15610de5576001600383815481101515610cf557fe5b906000526020600020906006020160050160006101000a81548160ff021916908315150217905550600090505b600180549050811015610de457600181815481101515610d3e57fe5b906000526020600020900160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff166108fc600180549050600385815481101515610d9857fe5b906000526020600020906006020160030154811515610db357fe5b049081150290604051600060405180830381858888f193505050501515610dd957600080fd5b806001019050610d22565b5b50505050565b6000804262015180610dfb6106bf565b02019050806006541015610e125760019150610e17565b600091505b5090565b60006001905090565b60065481565b60045481565b600381815481101515610e3f57fe5b90600052602060002090600602016000915090508060000154908060010154908060020154908060030154908060040154908060050160009054906101000a900460ff16905086565b602060405190810160405280600081525090565b815481835581811511610ec357818360005260206000209182019101610ec29190610f0e565b5b505050565b602060405190810160405280600081525090565b815481835581811511610f0957600602816006028360005260206000209182019101610f089190610f33565b5b505050565b610f3091905b80821115610f2c576000816000905550600101610f14565b5090565b90565b610f8b91905b80821115610f875760008082016000905560018201600090556002820160009055600382016000905560048201600090556005820160006101000a81549060ff021916905550600601610f39565b5090565b905600a165627a7a72305820fb80d500abce27c95c3c7cf88c847901292dff2fcb4b880072fa9f9140c61b0b0029"

//function hashes
var createMilestone = "66eae86e"
var daysSinceInception = "11b5e6f0"
var endDate = "c24a0f8b"
var fund = "b60d4288"
var getIndividuals = "001a2d42"
var getInitializer = "3e104a95"
var getContractDetails = "543fs25"
var getMilestones = "629e4ed0"
var getNextMilestoneNum = "9f272ee2"
var getSponsors = "8ce900bd"
var getTotalMilestoneNum = "4258cb9e"
var individuals = "66542aa7"
var initializerFunction = "e1631c1b"
var milestones = "e89e4ed6"
var numMilestones = "cedece74"
var payoutMilestone = "b116619d" //finish contract
var sponsors = "93066b4"
var startDate = "0b97bc86"

func main() {
	startAPI() // Start Server
	var response Response

	out, err := exec.Command("qtum-cli", "--regtest", "-datadir=/home/deon/.qtum3", "-rpcport=2236", "getinfo").Output()
	if err != nil {
		fmt.Println(err.Error())
	}
	outAsString := string(out)
	text := strings.Replace(outAsString, "\n", "", -1)
	text = strings.Replace(text, " ", "", -1)

	err = json.Unmarshal([]byte(text), &response)
	fmt.Scanln()
}

func DeployContract() []byte {
	var response CreateContractResponse
	entity := getEntity(1)
	out, err := exec.Command("qtum-cli", "--regtest", entity.datadir, entity.rpcPort, "createcontract", bin, "381382").Output()
	if err != nil {
		fmt.Println(err.Error())
	}
	outAsString := string(out)
	text := strings.Replace(outAsString, "\n", "", -1)
	text = strings.Replace(text, " ", "", -1)
	fmt.Println(text)
	_ = json.Unmarshal([]byte(text), &response)
	mostRecentAddress = response.Address
	return []byte(text)
}

func (entity *Entity) getHexAddress() []byte {
	out, err := exec.Command("qtum-cli", "--regtest", entity.datadir, entity.rpcPort, "gethexaddress", "x").Output()
	if err != nil {
		fmt.Println(err.Error())
	}
	outAsString := string(out)
	text := strings.Replace(outAsString, "\n", "", -1)
	text = strings.Replace(text, " ", "", -1)
	return []byte(text)
}

func joinContractBlockchain(person int) []byte {
	isSponsor := "1"
	if person == 2 {
		isSponsor = "0"
	}
	entity := getEntity(person)

	out, err := exec.Command("ethabi", "encode", "function", "../contract/TheCollectiveABI.json", "joinCollective", "-p", isSponsor).Output()
	if err != nil {
		fmt.Println(err.Error())
	}
	outAsString := string(out)
	abiEncded := strings.Replace(outAsString, "\n", "", -1)
	abiEncded = strings.Replace(abiEncded, " ", "", -1)

	out, err = exec.Command("qtum-cli", "--regtest", entity.datadir, entity.rpcPort, "sendtocontract", mostRecentAddress, abiEncded).Output()
	if err != nil {
		fmt.Println(err.Error())
	}
	outAsString = string(out)
	text := strings.Replace(outAsString, "\n", "", -1)
	text = strings.Replace(text, " ", "", -1)
	return []byte(text)
}

func participateContractBlockchain() []byte {
	entity := getEntity(1)

	out, err := exec.Command("ethabi", "encode", "function", "../contract/TheCollectiveABI.json", mostRecentAddress, getContractDetails).Output()
	if err != nil {
		fmt.Println(err.Error())
	}
	outAsString := string(out)
	abiEncded := strings.Replace(outAsString, "\n", "", -1)
	abiEncded = strings.Replace(abiEncded, " ", "", -1)

	out, err = exec.Command("qtum-cli", "--regtest", entity.datadir, entity.rpcPort, "sendtocontract", mostRecentAddress, abiEncded).Output()
	if err != nil {
		fmt.Println(err.Error())
	}
	outAsString = string(out)
	text := strings.Replace(outAsString, "\n", "", -1)
	text = strings.Replace(text, " ", "", -1)
	return []byte(text)
}

func finishContractBlockchain() []byte {
	entity := getEntity(1)

	out, err := exec.Command("ethabi", "encode", "function", "../contract/TheCollectiveABI.json", "joinContract").Output()
	if err != nil {
		fmt.Println(err.Error())
	}
	outAsString := string(out)
	abiEncded := strings.Replace(outAsString, "\n", "", -1)
	abiEncded = strings.Replace(abiEncded, " ", "", -1)

	out, err = exec.Command("qtum-cli", "--regtest", entity.datadir, entity.rpcPort, "sendtocontract", mostRecentAddress, abiEncded).Output()
	if err != nil {
		fmt.Println(err.Error())
	}
	outAsString = string(out)
	text := strings.Replace(outAsString, "\n", "", -1)
	text = strings.Replace(text, " ", "", -1)
	return []byte(text)
}

func getContractInformationBlockchain() []byte {
	entity := getEntity(1)

	out, err := exec.Command("qtum-cli", "--regtest", entity.datadir, entity.rpcPort, "callcontract", mostRecentAddress).Output()
	if err != nil {
		fmt.Println(err.Error())
	}
	outAsString := string(out)
	text := strings.Replace(outAsString, "\n", "", -1)
	text = strings.Replace(text, " ", "", -1)
	return []byte(text)
}

func getEntity(person int) Entity {
	var entity Entity
	// Person One is Company
	if person == 1 {
		entity.rpcPort = "-datadir=/home/deon/.qtum3"
		entity.datadir = "-rpcport=2236"
	}
	// Personal Two is Participant
	if person == 2 {
		entity.rpcPort = "-datadir=/home/deon/.qtum1"
		entity.datadir = "-rpcport=2234"
	}
	// Personal Three is Friend
	if person == 3 {
		entity.rpcPort = "-datadir=/home/deon/.qtum4"
		entity.datadir = "-rpcport=2237"
	}
	entity.getHexAddress()
	return entity
}

func generateBlocks() {
	entity := getEntity(1)
	_, err := exec.Command("qtum-cli", "--regtest", entity.datadir, entity.rpcPort, "generate", "2").Output()
	if err != nil {
		fmt.Println(err.Error())
	}
	entity = getEntity(2)
	_, err = exec.Command("qtum-cli", "--regtest", entity.datadir, entity.rpcPort, "generate", "2").Output()
	if err != nil {
		fmt.Println(err.Error())
	}
	entity = getEntity(3)
	_, err = exec.Command("qtum-cli", "--regtest", entity.datadir, entity.rpcPort, "generate", "2").Output()
	if err != nil {
		fmt.Println(err.Error())
	}
}
